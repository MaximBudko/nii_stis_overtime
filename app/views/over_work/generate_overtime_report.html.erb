<%= form_with url: do_generate_ov_path(format: :xlsx), method: :post, local: true do |f| %>
  <fieldset>
    <legend><strong>–î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç:</strong></legend>
    <div style="display: flex; gap: 20px;">
      <div>
        <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label><br>
        <%= date_field_tag :start_date, nil, id: 'start_date_picker' %>
      </div>
      <div>
        <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label><br>
        <%= date_field_tag :end_date, nil, id: 'end_date_picker' %>
      </div>
    </div>
  </fieldset>

  <fieldset style="margin-top: 20px;">
    <legend><strong>–¢–∏–ø –æ—Ç—á–µ—Ç–∞:</strong></legend>
    <%= select_tag :option_select, options_for_select([['–í –≤—ã—Ö–æ–¥–Ω—ã–µ', 'option_1'], ['–í –±—É–¥–Ω–∏', 'option_2']]), include_blank: '--- –í—ã–±–µ—Ä–∏—Ç–µ ---' %>
  </fieldset>

  <fieldset style="margin-top: 20px;">
    <legend><strong>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Å "–°–≤–µ—Ä—Ö—É—Ä–æ—á–Ω–æ–π" —Ä–∞–±–æ—Ç–æ–π:</strong></legend>
    <div id="user_cards_container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;"></div>
  </fieldset>

  <br>
  <%= f.submit "üöÄ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç (Excel) üöÄ", class: "button submit-button" %>
<% end %>

<%= javascript_tag do %>
  document.addEventListener('DOMContentLoaded', () => {
    const startInput = document.getElementById('start_date_picker');
    const endInput = document.getElementById('end_date_picker');
    const userContainer = document.getElementById('user_cards_container');

    function fetchUsers() {
      const startDate = startInput.value;
      const endDate = endInput.value;

      if (!startDate || !endDate) return;

      fetch(`/overtime_report/users_by_date?start_date=${startDate}&end_date=${endDate}`, {
        headers: { 'Accept': 'application/json' }
      })
      .then(response => response.json())
      .then(users => {
        userContainer.innerHTML = '';

        if (users.length === 0) {
          userContainer.innerHTML = '<p>–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å "–°–≤–µ—Ä—Ö—É—Ä–æ—á–Ω–æ–π" —Ä–∞–±–æ—Ç–æ–π –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.</p>';
          return;
        }

        users.forEach(user => {
          const card = document.createElement('label');
          card.className = 'user-card';

          const topLine = document.createElement('div');
          topLine.className = 'top-line';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.name = 'user_ids[]';
          checkbox.value = user.id;

          const name = document.createElement('span');
          name.className = 'user-name';
          name.textContent = user.name;

          topLine.appendChild(checkbox);
          topLine.appendChild(name);

          const dates = document.createElement('div');
          dates.className = 'user-dates';

          dates.innerHTML = user.entries.map(entry => {
            const d = new Date(entry.date);
            const weekday = d.toLocaleDateString('ru-RU', { weekday: 'short' });
            return `${d.toLocaleDateString()} (${weekday}) ‚Äì ${entry.hours} —á`;
          }).join('<br>');

          card.appendChild(topLine);
          card.appendChild(dates);
          userContainer.appendChild(card);
        });
      });
    }

    startInput.addEventListener('change', fetchUsers);
    endInput.addEventListener('change', fetchUsers);
  });
<% end %>

<style>
  .user-card {
    display: flex;
    flex-direction: column;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    background: #f9f9f9;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .user-card:hover {
    background: #eef;
  }

  .top-line {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
  }

  .top-line input[type="checkbox"] {
    margin: 0;
  }

  .user-name {
    font-weight: bold;
  }

  .user-dates {
    font-size: 12px;
    color: #555;
    margin-left: 22px;
  }

  .submit-button {
    background-color: #0073e6 !important;
    color: #fff !important;
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    font-weight: bold;
    cursor: pointer;
  }

  .submit-button:hover {
    background-color: #005bb5 !important;
  }
</style>
